<div class="logs-page">
  <header class="page-header">
    <h1>Logs</h1>
    <span class="total-count">{{ totalHits | number }} total</span>
  </header>

  <div class="filters">
    <div class="search-box">
      <input 
        type="text" 
        class="input search-input" 
        placeholder="Search logs..." 
        [(ngModel)]="searchQuery"
        (keyup.enter)="onSearch()">
      <select class="input project-select" [(ngModel)]="selectedProjectId" (change)="onSearch()">
        <option value="">All Projects</option>
        @for (project of availableProjects; track project) {
          <option [value]="project">{{ project }}</option>
        }
      </select>
      <button class="btn primary" (click)="onSearch()">Search</button>
    </div>
    
    <div class="level-filters">
      @for (level of levels; track level) {
        <button 
          class="level-btn"
          [class.active]="isLevelSelected(level)"
          [ngClass]="level.toLowerCase()"
          (click)="toggleLevel(level)">
          {{ level }}
        </button>
      }
    </div>

  </div>

  @if (loading) {
    <div class="loading">Loading logs...</div>
  } @else if (error) {
    <div class="error-message">{{ error }}</div>
  } @else {
    <div class="logs-list">
      @for (log of logs; track log.id) {
        <div class="log-entry" [class.expanded]="isExpanded(log.id)" (click)="toggleExpand(log.id)">
          <div class="log-header">
            <span class="badge" [ngClass]="getLevelClass(log.level)">{{ log.level }}</span>
            <span class="timestamp">{{ formatTimestamp(log.timestamp) }}</span>
            @if (log.projectId) {
              <span class="project-badge">{{ log.projectId }}</span>
            }
            @if (log.traceId) {
              <button class="trace-id-btn" (click)="openTraceView(log.traceId, $event)" title="View Request Timeline">
                <svg viewBox="0 0 24 24" fill="none" width="12" height="12">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                {{ log.traceId.substring(0, 8) }}
              </button>
            }
            <span class="logger">{{ log.logger }}</span>
          </div>
          <div class="log-message">{{ log.message }}</div>
          
          @if (isExpanded(log.id)) {
            <div class="log-details">
              @if (log.stackTrace) {
                <div class="stack-trace">
                  <div class="detail-label">Stack Trace</div>
                  <pre>{{ log.stackTrace }}</pre>
                </div>
              }
              <div class="metadata">
                @if (log.projectId) {
                  <div class="meta-item">
                    <span class="meta-label">Project:</span>
                    <span class="meta-value">{{ log.projectId }}</span>
                  </div>
                }
                @if (log.serviceName) {
                  <div class="meta-item">
                    <span class="meta-label">Service:</span>
                    <span class="meta-value">{{ log.serviceName }}</span>
                  </div>
                }
                @if (log.exceptionClass) {
                  <div class="meta-item">
                    <span class="meta-label">Exception:</span>
                    <span class="meta-value exception">{{ log.exceptionClass }}</span>
                  </div>
                }
                @if (log.environment) {
                  <div class="meta-item">
                    <span class="meta-label">Environment:</span>
                    <span class="meta-value">{{ log.environment }}</span>
                  </div>
                }
                @if (log.hostName) {
                  <div class="meta-item">
                    <span class="meta-label">Host:</span>
                    <span class="meta-value">{{ log.hostName }}</span>
                  </div>
                }
                @if (log.traceId) {
                  <div class="meta-item">
                    <span class="meta-label">Trace ID:</span>
                    <span class="meta-value mono">{{ log.traceId }}</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      } @empty {
        <div class="no-data">No logs found</div>
      }
    </div>

    @if (totalPages > 1) {
      <div class="pagination">
        <button class="btn" [disabled]="currentPage === 0" (click)="previousPage()">Previous</button>
        <div class="page-input-container">
          <span>Page</span>
          <input 
            type="number" 
            class="page-input" 
            [value]="currentPage + 1" 
            min="1" 
            [max]="totalPages"
            (change)="goToPage($event)">
          <span>of {{ totalPages }}</span>
        </div>
        <button class="btn" [disabled]="currentPage >= totalPages - 1" (click)="nextPage()">Next</button>
      </div>
    }
  }
</div>
